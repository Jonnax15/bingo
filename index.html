<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bingo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .bar { transition: width 700ms cubic-bezier(.2,.8,.2,1); }

      body.theme-light { color:#0f172a; }
      body.theme-light.bg-gradient { background:linear-gradient(to bottom,#ffffff,#f8fafc,#eef2f7); }
      body.theme-light .info-card{ background:rgba(255,255,255,0.95)!important; border-color:#e2e8f0!important; color:#0f172a; }
      body.theme-light .progress-track{ background:#e2e8f0!important; }
      body.theme-light .bar{ background:#10b981!important; }
      body.theme-light .day{ border-color:#e2e8f0!important; color:#0f172a; background:rgba(255,255,255,0.95)!important; }
      body.theme-light .day:hover{ box-shadow:0 10px 24px rgba(15,23,42,0.08); }

      .bg-gradient{ background-image:linear-gradient(to bottom,#0f172a,#0b1324,#000000); }

      /* Karten-Layout: immer echte Quadrate unabh√§ngig vom Text */
      .day { position: relative; border-radius: 1rem; overflow: hidden; }
      .square { position: relative; width: 100%; padding-top: 100%; } /* 1:1-Quadrat */
      .content { position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; padding: 10px; }
      .label{
        font-weight:600; text-align:center; line-height:1.15; opacity:1;
        /* Lesbarkeit: keine Trennstriche, aber weiche Umbr√ºche erlaubt */
        word-break: normal; overflow-wrap: anywhere; hyphens: none;
        /* Startgr√∂√üe ‚Äì wird per JS automatisch verkleinert falls n√∂tig */
        font-size:16px; max-width:90%;
      }
      .check-wrap { position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:1; pointer-events:none; }
      .day.checked .check-wrap { display:flex; }
      .day.checked .label { opacity: .35; } /* Text bleibt voll sichtbar */
    </style>
  </head>
  <body class="min-h-screen w-full bg-gradient text-slate-100 p-6">
    <div class="max-w-3xl mx-auto" id="app"></div>

    <script type="module">
      const START = "2025-10-02";
      const END   = "2025-10-17";

      const API_URL = "/api/checks";
      const STORAGE_KEY = "kalender-checks-2025-10-02_2025-10-17";

      let clickLock = false;
      let checks = {};
      let remoteReady = false;

      const $ = (s,r=document)=>r.querySelector(s);
      const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
      const debounce=(fn,ms=250)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};
      const pad = (n)=>String(n).padStart(2,'0');

      function toParts(iso){const[y,m,d]=iso.split("-").map(Number);return{y,m,d};}
      function makeDate(y,m,d){return new Date(Date.UTC(y,m-1,d));}
      function daysBetween(a,b){const ap=toParts(a),bp=toParts(b);return Math.round((makeDate(bp.y,bp.m,bp.d)-makeDate(ap.y,ap.m,ap.d))/(1000*60*60*24));}
      function range(start,end){const s=toParts(start),total=daysBetween(start,end)+1,out=[];for(let i=0;i<total;i++){const d=makeDate(s.y,s.m,s.d+i);out.push(`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`);}return out;}

      const allDays = range(START, END);

      const dayTexts = [
        "Mit allem drum und dran", "Kannste n√ºscht sagen", "Ganz Perfekt", "Wenn uns der Spa√ü verl√§sst",
        "Da gibts gar keine Probleme", "Den kenn ich gut", "Da hab ich Antennenm√§√üig schon mal was gemacht", "Viel trinken sagt mein Arzt immer",
        "Ich sag dazu n√ºscht, ABER", "Muss jeder selber wissen", "Die machen schon ihr Ding", "Man muss auch mal mit den Leuten reden",
        "Sagt Waschi doch", "Im Kulturpalast, da kannste dir die Parkkarte entwerten lassen und bezahlst blo√ü...", "Wir fahren immer bissl eher los, falls mal was ist", "Test 16"
      ];

      let theme=localStorage.getItem('theme')||'dark';
      function applyTheme(){ document.body.classList.toggle('theme-light', theme==='light'); }
      applyTheme();

      function readLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? (JSON.parse(raw) || {}) : {}; }catch{ return {}; } }
      function writeLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(checks)); }

      async function loadRemote(){
        try{
          const r = await fetch(API_URL, { headers: { 'Accept':'application/json' }, cache:'no-store' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const data = await r.json();
          checks = data.checks || {};
          writeLocal();
        }catch(e){
          const local = readLocal();
          checks = local || {};
        }finally{ remoteReady = true; render(); }
      }
      loadRemote();

      const save = debounce(async ()=>{
        writeLocal();
        try{
          await fetch(API_URL, { method:'PUT', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ checks }) });
        }catch(e){ /* ignore */ }
      }, 200);

      function infoCard(title,value,sub){
        return `<div class="info-card rounded-2xl bg-slate-900/60 backdrop-blur border border-slate-800 p-4 shadow-xl">
          <div class="text-sm text-slate-400">${title}</div>
          <div class="text-2xl font-semibold mt-1">${value}</div>
          ${sub?`<div class="text-xs text-slate-500 mt-1">${sub}</div>`:''}
        </div>`;
      }

      function computeYellowSet() {
        const yellow = new Set();
        for (let r = 0; r < 4; r++) {
          const idxs = [r*4, r*4+1, r*4+2, r*4+3];
          const allChecked = idxs.every(i => checks[allDays[i]]);
          if (allChecked) idxs.forEach(i => yellow.add(i));
        }
        for (let c = 0; c < 4; c++) {
          const idxs = [c, c+4, c+8, c+12];
          const allChecked = idxs.every(i => checks[allDays[i]]);
          if (allChecked) idxs.forEach(i => yellow.add(i));
        }
        const diag1 = [0,5,10,15];
        const diag2 = [3,6,9,12];
        if (diag1.every(i => checks[allDays[i]])) diag1.forEach(i => yellow.add(i));
        if (diag2.every(i => checks[allDays[i]])) diag2.forEach(i => yellow.add(i));
        return yellow;
      }

      /* üî§ Einheitliche Schriftgr√∂√üe: nimm die kleinste, die in allen Kacheln passt (H√∂he & Breite) */
      function autosizeLabelsUniform(){
        const boxes = $$('.day .content');
        const MIN = 10, MAX = 18;

        // 0) Start auf MAX (saubere Basis)
        boxes.forEach(box => {
          const label = box.querySelector('.label');
          if (label) { label.style.fontSize = MAX + 'px'; label.style.lineHeight = '1.15'; }
        });

        // 1) Gr√∂√üte passende Gr√∂√üe je Feld via bin√§rer Suche ermitteln
        const sizes = [];
        boxes.forEach(box => {
          const label = box.querySelector('.label');
          if (!label) return;

          const maxH = box.clientHeight - 2; // kleiner Puffer
          const maxW = box.clientWidth  - 2;

          const fits = (size) => {
            label.style.fontSize = size + 'px';
            // Reflow triggern
            void label.offsetHeight;
            return (label.scrollHeight <= maxH) && (label.scrollWidth <= maxW);
          };

          let lo = MIN, hi = MAX;
          // Falls MAX passt, bleibt hi=MAX; sonst suche gr√∂√üte passende Gr√∂√üe
          if (!fits(hi)) {
            while (lo < hi) {
              const mid = Math.floor((lo + hi + 1) / 2); // upper mid
              if (fits(mid)) lo = mid; else hi = mid - 1;
            }
          }
          label.style.fontSize = lo + 'px';
          sizes.push(lo);
        });

        // 2) Kleinsten gefundenen Wert global anwenden
        const global = Math.max(MIN, Math.min(...sizes, MAX));
        boxes.forEach(box => {
          const label = box.querySelector('.label');
          if (label) { label.style.fontSize = global + 'px'; label.style.lineHeight = '1.15'; }
        });
      }

      function dayCard(day,index,{checked,yellow}){
        const label = dayTexts[index] || "Test";
        const borderClass = checked ? (yellow ? 'border-yellow-300/70' : 'border-emerald-400/60') : 'border-slate-800';
        const tickColor = yellow ? 'text-yellow-300' : 'text-emerald-400';
        return `<button data-day="${day}"
          class="day relative w-full border bg-slate-900/60 backdrop-blur shadow-xl ${checked ? 'checked ' : ''}${borderClass} hover:-translate-y-0.5 hover:shadow-2xl">
          <div class="square">
            <div class="content">
              <div class="label text-sm sm:text-base">${label}</div>
              <div class="check-wrap">
                <svg class="tick h-8 w-8 ${tickColor}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
              </div>
            </div>
          </div>
        </button>`;
      }

      let resizeBound = false;
      function render(){
        if(!remoteReady){ $('#app').innerHTML='<div class="p-10 text-center text-slate-300">Lade‚Ä¶</div>'; return; }

        const doneCount=allDays.filter(d=>checks[d]).length;
        const openCount=allDays.length-doneCount;
        const progress=Math.round((doneCount/allDays.length)*100);
        const yellowSet = computeYellowSet();

        $('#app').innerHTML=`
          <header class="mb-6 flex items-center justify-between">
            <div>
              <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">Bingo</h1>
            </div>
            <div class="flex items-center gap-2">
              <button id="theme" class="rounded-2xl px-3 py-2 bg-slate-800/60 hover:bg-slate-800 shadow-lg shadow-slate-900/40 transition" title="Theme wechseln">üåô/‚òÄÔ∏è</button>
              <button id="reset" class="rounded-2xl px-4 py-2 bg-slate-800/60 hover:bg-slate-800 shadow-lg shadow-slate-900/40 transition">Zur√ºcksetzen</button>
            </div>
          </header>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            ${infoCard('Fortschritt', `${progress}%`, `${doneCount} geschafft ¬∑ ${openCount} offen`)}
          </div>

          <div class="mb-6">
            <div class="h-3 rounded-full progress-track bg-slate-800 overflow-hidden">
              <div class="h-full bg-emerald-400 bar" style="width:${progress}%"></div>
            </div>
          </div>

          <div class="grid grid-cols-4 gap-2 sm:gap-3 md:gap-4 max-w-[420px] mx-auto">
            ${allDays.map((day, i)=>dayCard(day,i,{checked:!!checks[day], yellow: yellowSet.has(i)})).join('')}
          </div>

          <footer class="mt-10 text-slate-400 text-sm"><p>Hinweis: Fortschritt wird zentral gespeichert.</p></footer>
        `;

        document.getElementById('reset').addEventListener('click', ()=>{ if(confirm('Alles zur√ºcksetzen?')){ checks={}; save(); render(); } });
        document.getElementById('theme').addEventListener('click', ()=>{ theme = (theme==='light'?'dark':'light'); localStorage.setItem('theme',theme); applyTheme(); });

        $$('.day').forEach(el=>{
          el.addEventListener('click', ()=>{
            const day=el.dataset.day;
            if(clickLock) return;
            const willCheck=!checks[day];
            if(willCheck){checks[day]=true;} else {delete checks[day];}
            save();
            render();
          });
        });

        // Nach dem Rendern: einheitliche (kleinstm√∂gliche) Schriftgr√∂√üe anwenden
        autosizeLabelsUniform();
        if (!resizeBound) {
          window.addEventListener('resize', debounce(autosizeLabelsUniform, 150));
          resizeBound = true;
        }
      }

      render();
    </script>
  </body>
</html>
